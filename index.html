<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Presensi Guru QR</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    :root {
      --bg: #f6f7fb;
      --card: #ffffff;
      --accent: #2b8aef;
      --success: #1b7a3a;
      --warn: #b36b00;
      --danger: #d32f2f;
    }
    body {
      margin: 0;
      font-family: Inter, Arial, sans-serif;
      background: var(--bg);
      color: #222;
      display: flex;
      min-height: 100vh;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .container {
      width: 100%;
      max-width: 820px;
      background: var(--card);
      border-radius: 12px;
      box-shadow: 0 6px 22px rgba(15,20,30,0.08);
      padding: 22px;
    }
    h1 {
      margin: 0 0 12px 0;
      font-size: 20px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .layout {
      display: grid;
      grid-template-columns: 420px 1fr;
      gap: 18px;
      align-items: start;
    }
    #reader {
      width: 100%;
      background: #000;
      border-radius: 10px;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 300px;
    }
    #reader video {
      max-width: 100%;
      height: auto;
      display: block;
    }
    .info {
      padding: 8px 12px;
    }
    #hasil {
      margin-top: 12px;
      padding: 12px;
      border-radius: 8px;
      background: rgba(43,138,239,0.06);
      color: #0b2947;
      font-weight: 600;
      min-height: 48px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .status-success {
      background: rgba(27,122,58,0.08);
      color: var(--success);
    }
    .status-warn {
      background: rgba(179,107,0,0.06);
      color: var(--warn);
    }
    .status-danger {
      background: rgba(211,47,47,0.06);
      color: var(--danger);
    }
    .controls {
      margin-top: 10px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    button {
      border: none;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      background: var(--accent);
      color: white;
      font-weight: 600;
    }
    button.secondary {
      background: #e6eefb;
      color: #14589b;
      font-weight: 600;
    }
    small {
      display:block;
      margin-top:8px;
      color:#666;
    }
    @media (max-width: 780px) {
      .layout { grid-template-columns: 1fr; }
      #reader { min-height: 260px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üì∑ Presensi Guru ‚Äî Scan QR</h1>
    <div class="layout">
      <div>
        <div id="reader"></div>
        <div style="margin-top:10px; display:flex; justify-content:space-between; gap:8px;">
          <div style="flex:1;">
            <div style="font-size:13px; color:#555;">Kamera aktif. Arahkan kartu QR ke kotak deteksi.</div>
            <small>Jika kamera tidak bekerja: pastikan izin kamera diberikan dan buka halaman lewat HTTPS / localhost.</small>
          </div>
          <div style="display:flex; gap:8px; align-items:center;">
            <button id="stopBtn" class="secondary">Stop</button>
            <button id="startBtn">Start</button>
          </div>
        </div>
      </div>

      <div class="info">
        <div id="hasil">Arahkan kartu QR ke kamera untuk presensi.</div>

        <div class="controls" style="margin-top:14px;">
          <button id="testSend">Tes Kirim Manual</button>
          <button id="clearMsg" class="secondary">Clear</button>
        </div>

        <div style="margin-top:12px; font-size:13px; color:#666;">
          <div><strong>Catatan:</strong></div>
          <ul style="padding-left:18px; margin:6px 0;">
            <li>Setiap ID hanya boleh tercatat <em>satu kali per hari</em> (cek dilakukan di Google Sheets).</li>
            <li>Pastikan <code>webAppURL</code> mengarah ke Google Apps Script Web App yang benar.</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ======= PENTING: ganti dengan URL Web App Google Apps Script Anda =======
    const webAppURL = "https://script.google.com/macros/s/AKfycbzljlI3Y_CgiY0HHUcSyxW6j9dYQf4w3lRkOYlCBap0PgZXlVNYSG0SzJBXTDPq6tat/exec";
    // ======================================================================

    let html5QrCode = null;
    let isScanning = false;
    let scanCooldown = false; // mencegah pengiriman ganda cepat
    const COOLDOWN_MS = 3000; // jeda 3 detik setelah setiap hasil scan
    const hasilEl = document.getElementById("hasil");
    const stopBtn = document.getElementById("stopBtn");
    const startBtn = document.getElementById("startBtn");
    const testSendBtn = document.getElementById("testSend");
    const clearMsgBtn = document.getElementById("clearMsg");

    function setMessage(text, type) {
      // type: "info" | "success" | "warn" | "danger"
      hasilEl.className = "";
      if (type === "success") hasilEl.classList.add("status-success");
      else if (type === "warn") hasilEl.classList.add("status-warn");
      else if (type === "danger") hasilEl.classList.add("status-danger");
      hasilEl.innerHTML = text;
    }

    function kirimKeSheets(data) {
      // kirim ke Web App, kembalikan Promise teks balasan
      return fetch(webAppURL + "?data=" + encodeURIComponent(data), { method: "GET", cache: "no-cache" })
        .then(res => res.text());
    }

    function handleServerResponse(originalData, txt) {
      // menampilkan pesan sesuai balasan dari Apps Script
      if (!txt) {
        setMessage("‚ùå Respon kosong dari server", "danger");
        return;
      }
      txt = txt.toString();
      if (txt.indexOf("Sukses") !== -1) {
        setMessage("‚úÖ Presensi berhasil: <b>" + escapeHtml(originalData) + "</b>", "success");
      } else if (txt.indexOf("Sudah absen") !== -1 || txt.indexOf("Sudah") !== -1) {
        setMessage("‚ö† " + escapeHtml(originalData) + " sudah absen hari ini.", "warn");
      } else if (txt.indexOf("Gagal") !== -1) {
        setMessage("‚ùå Gagal: " + escapeHtml(txt), "danger");
      } else {
        // fallback
        setMessage("‚ÑπÔ∏è Respon server: " + escapeHtml(txt), "info");
      }
    }

    function escapeHtml(unsafe) {
      return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function onScanSuccess(decodedText, decodedResult) {
      if (scanCooldown) {
        // abaikan hasil selama cooldown
        return;
      }
      scanCooldown = true;
      // set cooldown timeout
      setTimeout(() => { scanCooldown = false; }, COOLDOWN_MS);

      setMessage("Mengirim data: <b>" + escapeHtml(decodedText) + "</b> ...", "info");

      kirimKeSheets(decodedText)
        .then(txt => {
          handleServerResponse(decodedText, txt);
        })
        .catch(err => {
          console.error("Fetch error:", err);
          setMessage("‚ùå Gagal kirim data! (cek koneksi atau Web App URL)", "danger");
        });
    }

    function startScanner() {
      if (isScanning) return;
      html5QrCode = new Html5Qrcode("reader", /* verbose= */ false);
      Html5Qrcode.getCameras().then(devices => {
        if (!devices || devices.length === 0) {
          setMessage("Kamera tidak ditemukan!", "danger");
          return;
        }
        // pilih kamera belakang jika tersedia (device label bisa mengandung 'back' atau 'rear')
        let cameraId = devices[0].id;
        for (let d of devices) {
          const label = (d.label || "").toLowerCase();
          if (label.includes("back") || label.includes("rear") || label.includes("environment")) {
            cameraId = d.id;
            break;
          }
        }

        html5QrCode.start(
          cameraId,
          {
            fps: 10,
            qrbox: { width: 250, height: 250 },
            aspectRatio: 1.333
          },
          onScanSuccess
        ).then(() => {
          isScanning = true;
          setMessage("Kamera aktif. Arahkan kartu QR ke kotak deteksi.", "info");
        }).catch(err => {
          console.error("Start error:", err);
          setMessage("Gagal memulai kamera: " + err, "danger");
        });
      }).catch(err => {
        console.error("getCameras error:", err);
        setMessage("Gagal mengakses kamera! Pastikan izin diberikan dan halaman dibuka lewat HTTPS atau localhost.", "danger");
      });
    }

    function stopScanner() {
      if (!isScanning || !html5QrCode) return;
      html5QrCode.stop().then(() => {
        html5QrCode.clear();
        isScanning = false;
        setMessage("Scanner dihentikan.", "info");
      }).catch(err => {
        console.error("Stop error:", err);
        setMessage("Gagal menghentikan scanner: " + err, "danger");
      });
    }

    // Tombol control
    stopBtn.addEventListener("click", () => {
      stopScanner();
    });
    startBtn.addEventListener("click", () => {
      startScanner();
    });

    // Tombol tes kirim manual (berguna untuk cek Web App)
    testSendBtn.addEventListener("click", () => {
      const sample = "TEST_ID_001 | Nama Test";
      setMessage("Mengirim data tes...", "info");
      kirimKeSheets(sample)
        .then(txt => {
          handleServerResponse(sample, txt);
        })
        .catch(err => {
          console.error(err);
          setMessage("‚ùå Gagal kirim data tes!", "danger");
        });
    });

    clearMsgBtn.addEventListener("click", () => {
      setMessage("Arahkan kartu QR ke kamera untuk presensi.", "info");
    });

    // Mulai scanner otomatis saat halaman siap
    window.addEventListener("load", () => {
      startScanner();
    });

    // Hentikan kamera saat meninggalkan halaman
    window.addEventListener("beforeunload", () => {
      if (isScanning && html5QrCode) {
        try { html5QrCode.stop(); } catch(e) {}
      }
    });

  </script>
</body>
</html>
